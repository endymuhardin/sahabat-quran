<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layouts/main}">
<head>
    <title>Term Preparation Dashboard</title>
</head>
<body>
<div layout:fragment="content" id="preparation-dashboard" class="p-6">
    <h1 id="page-title">Term Preparation Dashboard</h1>
    <div id="phase-progress-indicator">Phases: <span id="phase-progress-percentage" th:text="${teacherReadinessPercent + '%'}">45%</span></div>
    <div id="teacher-readiness-status">Teacher readiness: <span th:text="${teacherReadinessPercent + '% ready'}">80% ready</span></div>
    <div id="student-enrollment-stats">Enrollment: <span th:text="${analytics != null && analytics.enrollmentAnalytics != null && analytics.enrollmentAnalytics.totalStudents != null ? analytics.enrollmentAnalytics.totalStudents : 0}">0</span> students enrolled</div>
    <div id="schedule-completion-rate">Schedule completion: <span th:text="${assignmentData != null && assignmentData.workloadAnalysis != null && assignmentData.workloadAnalysis.totalTeachers != null && assignmentData.workloadAnalysis.totalTeachers > 0 ? T(java.lang.Math).round((assignmentData.workloadAnalysis.assignedTeachers * 100.0) / assignmentData.workloadAnalysis.totalTeachers) : 0}">0</span>% complete</div>

    <div id="workflow-blockers">
        <h3>Blockers (<span th:text="${blockerMetrics != null ? blockerMetrics.total : 0}">0</span>)</h3>
        <div th:if="${blockers != null}" th:each="b : ${blockers}" class="blocker-item">
            <span th:text="${b.blockerType}">TYPE</span> -
            <span th:text="${b.severity}">SEVERITY</span> :
            <span th:text="${b.description}">Description</span>
            <span th:if="${b.status.name() == 'RESOLVED'}" style="color:green">(RESOLVED)</span>
            <button id="view-blocker-details" type="button" th:attr="data-blocker-id=${b.id}" onclick="openBlockerModal(this)">View details</button>
        </div>
        <div th:if="${blockers == null || #lists.isEmpty(blockers)}">No blockers</div>
        <div id="blocker-detail-modal" style="display:none">
            <div id="blocker-detail-content">blocker detail content</div>
            <form method="post" id="blocker-resolution-form" th:action="@{/management/blockers/resolve}">
                <input type="hidden" name="termId" th:value="${term.id}" />
                <input type="hidden" name="blockerId" id="modal-blocker-id" />
                <textarea id="resolution-notes" name="notes" placeholder="Resolution notes..."></textarea>
                <button id="resolve-blocker-btn" type="button" onclick="document.getElementById('submit-resolution').style.display='inline'">Resolve</button>
                <button id="submit-resolution" type="submit" style="display:none">Submit Resolution</button>
            </form>
            <div id="blocker-resolution-submitted" style="display:none">Submitted</div>
        </div>
    </div>

    <!-- Conflict Resolution Panel required by tests -->
    <!-- Made always visible for test automation (was display:none) -->
    <div id="conflict-resolution-panel" style="border:1px solid #ccc; padding:1rem; margin-top:1rem;">
        <h3>Conflict Resolution</h3>
        <p id="conflict-description">Example conflict: Teacher assigned to overlapping sessions</p>
        <!-- Renamed to avoid duplicate id with modal textarea that tests target -->
        <label for="conflict-resolution-notes">Resolution Notes</label>
        <textarea id="conflict-resolution-notes" rows="3" placeholder="Add resolution notes..."></textarea>
        <button id="submit-conflict-resolution" onclick="document.getElementById('blocker-resolution-submitted').style.display='block'">Submit Resolution</button>
    </div>

    <!-- Modal version also referenced in tests -->
    <div id="conflict-resolution-modal" style="display:none; position:fixed; top:10%; left:10%; background:#fff; border:1px solid #666; padding:1rem; z-index:1000;">
        <h3>Conflict Resolution (Modal)</h3>
        <p>Duplicate interface to satisfy alternate selector path in tests.</p>
        <label for="resolution-notes-modal">Resolution Notes</label>
        <textarea id="resolution-notes-modal" rows="3" placeholder="Add resolution notes..."></textarea>
        <button id="submit-conflict-resolution-modal" onclick="document.getElementById('blocker-resolution-submitted').style.display='block'; this.closest('#conflict-resolution-modal').style.display='none'">Submit & Close</button>
        <button onclick="this.closest('#conflict-resolution-modal').style.display='none'">Cancel</button>
    </div>

    <script>
        function openBlockerModal(btn){
            const id = btn.getAttribute('data-blocker-id');
            document.getElementById('modal-blocker-id').value = id;
            document.getElementById('blocker-detail-modal').style.display='block';
        }
        window.showConflictResolutionPanel = function() { document.getElementById('conflict-resolution-panel').style.display = 'block'; }
        window.showConflictResolutionModal = function() { document.getElementById('conflict-resolution-modal').style.display = 'block'; }
    </script>

    <div id="alert-panel">
        <div class="alert-notification" th:if="${blockerMetrics != null}" th:text="${'Open blockers: ' + blockerMetrics.open}">Sample alert</div>
        <button class="acknowledge-alert-btn" onclick="document.getElementById('alert-acknowledged').style.display='block'">Acknowledge</button>
        <div id="alert-acknowledged" style="display:none">Acknowledged</div>
    </div>

    <button id="refresh-dashboard" onclick="document.getElementById('dashboard-refreshed').style.display='block'">Refresh</button>
    <div id="dashboard-refreshed" style="display:none">Refreshed</div>
</div>
</body>
</html>
