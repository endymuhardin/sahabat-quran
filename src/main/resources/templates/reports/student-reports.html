<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layouts/main}">
<head>
    <title layout:fragment="title">Student Reports</title>
    <style>
        .report-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
            background: white;
        }
        .simple-form {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .generate-button {
            background-color: #2563eb;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .generate-button:hover {
            background-color: #1d4ed8;
        }
        .regenerate-button {
            background-color: #059669;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .regenerate-button:hover {
            background-color: #047857;
        }
    </style>
</head>

<div layout:fragment="content" class="container mx-auto px-4 py-6">
    <div id="student-reports">
        <!-- Page Header -->
        <div class="mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 id="student-reports-title" class="text-3xl font-bold text-gray-900">Student Reports</h1>
                    <p id="student-reports-subtitle" class="text-gray-600 mt-1">Generate reports for all students or regenerate individual reports</p>
                </div>
                <div class="flex space-x-3">
                    <a href="/report-cards/status" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 inline-flex items-center">
                        <i class="fas fa-chart-line mr-2"></i>View Status
                    </a>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div th:if="${errorMessage}" id="error-message" class="error-message bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
            <span th:text="${errorMessage}">Error message</span>
        </div>

        <div th:if="${successMessage}" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4">
            <span th:text="${successMessage}">Success message</span>
        </div>

        <!-- Main Generation Section -->
        <div class="simple-form mb-6">
            <h2 class="text-xl font-semibold mb-4">Generate All Student Reports</h2>
            <p class="text-gray-600 mb-6">Generate reports for all students in the selected term. Processing will run in the background.</p>

            <form th:action="@{/report-cards/generate-all}" method="post" class="space-y-4">
                <!-- Term Selection -->
                <div>
                    <label for="term-selector" class="block text-sm font-medium text-gray-700 mb-2">Academic Term</label>
                    <select required name="termId" id="term-selector" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Term</option>
                        <option th:each="term : ${terms}"
                                th:value="${term.id}"
                                th:text="${term.termName}"
                                th:selected="${selectedFilterTermId != null and selectedFilterTermId.equals(term.id)}">
                            Academic Term
                        </option>
                    </select>
                </div>

                <!-- Generate Button -->
                <div class="flex justify-start">
                    <button type="submit" id="btn-generate-all" class="generate-button">
                        <i class="fas fa-play mr-2"></i>Generate All Reports
                    </button>
                </div>
            </form>

            <div class="mt-4 p-4 bg-blue-50 rounded-md">
                <p class="text-sm text-blue-700">
                    <i class="fas fa-info-circle mr-2"></i>
                    Reports will be generated in the background. You can monitor progress on the status dashboard.
                </p>
            </div>
        </div>

        <!-- Individual Regeneration Section -->
        <div class="simple-form mb-6">
            <h2 class="text-xl font-semibold mb-4">Regenerate Individual Report</h2>
            <p class="text-gray-600 mb-6">Regenerate a specific student's report (deletes old report and creates new one).</p>

            <form th:action="@{/report-cards/regenerate}" method="post" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Student Selection -->
                    <div>
                        <label for="student-selector" class="block text-sm font-medium text-gray-700 mb-2">Select Student</label>
                        <select required name="studentId" id="student-selector" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Choose a student</option>
                            <option th:each="student : ${students}"
                                    th:value="${student.id}"
                                    th:text="${student.fullName}">
                                Student Name
                            </option>
                        </select>
                    </div>

                    <!-- Term Selection -->
                    <div>
                        <label for="regenerate-term-selector" class="block text-sm font-medium text-gray-700 mb-2">Academic Term</label>
                        <select required name="termId" id="regenerate-term-selector" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Term</option>
                            <option th:each="term : ${terms}"
                                    th:value="${term.id}"
                                    th:text="${term.termName}"
                                    th:selected="${selectedFilterTermId != null and selectedFilterTermId.equals(term.id)}">
                                Academic Term
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Regenerate Button -->
                <div class="flex justify-start">
                    <button type="submit" id="btn-regenerate" class="regenerate-button">
                        <i class="fas fa-redo mr-2"></i>Regenerate Report
                    </button>
                </div>
            </form>
        </div>

        <!-- Download Section -->
        <div class="simple-form mb-6">
            <h2 class="text-xl font-semibold mb-4">Download Reports</h2>
            <p class="text-gray-600 mb-6">Download pre-generated reports for individual students.</p>

            <form th:action="@{/report-cards/download-pdf}" method="get" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Student Selection for Download -->
                    <div>
                        <label for="download-student-selector" class="block text-sm font-medium text-gray-700 mb-2">Select Student</label>
                        <select required name="studentId" id="download-student-selector" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Choose a student</option>
                            <option th:each="student : ${students}"
                                    th:value="${student.id}"
                                    th:text="${student.fullName}">
                                Student Name
                            </option>
                        </select>
                    </div>

                    <!-- Term Selection for Download -->
                    <div>
                        <label for="download-term-selector" class="block text-sm font-medium text-gray-700 mb-2">Academic Term</label>
                        <select required name="termId" id="download-term-selector" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Term</option>
                            <option th:each="term : ${terms}"
                                    th:value="${term.id}"
                                    th:text="${term.termName}"
                                    th:selected="${selectedFilterTermId != null and selectedFilterTermId.equals(term.id)}">
                                Academic Term
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Download Button -->
                <div class="flex justify-start">
                    <button type="submit" id="btn-download-pdf" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        <i class="fas fa-download mr-2"></i>Download PDF
                    </button>
                </div>
            </form>
        </div>

        <!-- Students Overview -->
        <div class="simple-form">
            <h2 class="text-xl font-semibold mb-4">Students Overview</h2>
            <p class="text-gray-600 mb-4">Current students in the system:</p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div th:each="student : ${students}" class="p-4 border border-gray-200 rounded-md">
                    <h3 class="font-medium text-gray-900" th:text="${student.fullName}">Student Name</h3>
                    <p class="text-sm text-gray-600" th:text="${student.email}">email@example.com</p>
                </div>
            </div>

            <div th:if="${students == null or students.isEmpty()}" class="text-center py-8 text-gray-500">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>No students found</p>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts">
    // Simple form validation and UX improvements
    document.addEventListener('DOMContentLoaded', function() {
        // Enable/disable buttons based on form completion
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            const selects = form.querySelectorAll('select[required]');
            const button = form.querySelector('button[type="submit"]');

            function checkFormValidity() {
                const allValid = Array.from(selects).every(select => select.value !== '');
                button.disabled = !allValid;
                button.style.opacity = allValid ? '1' : '0.5';
            }

            selects.forEach(select => {
                select.addEventListener('change', checkFormValidity);
            });

            // Initial check
            checkFormValidity();
        });

        // Add confirmation for regeneration
        const regenerateForm = document.querySelector('form[action*="regenerate"]');
        if (regenerateForm) {
            regenerateForm.addEventListener('submit', function(e) {
                const studentSelect = this.querySelector('#student-selector');
                const termSelect = this.querySelector('#regenerate-term-selector');

                if (studentSelect.value && termSelect.value) {
                    const studentName = studentSelect.options[studentSelect.selectedIndex].text;
                    const termName = termSelect.options[termSelect.selectedIndex].text;

                    if (!confirm(`Are you sure you want to regenerate the report for ${studentName} in ${termName}? This will delete the existing report.`)) {
                        e.preventDefault();
                    }
                }
            });
        }
    });
</script>
</html>