<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title layout:fragment="title" th:text="${pageTitle}">Email Preview</title>
</head>

<body layout:fragment="content">
    <div class="container mx-auto px-4 py-6">

        <!-- Header -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h1 class="text-2xl font-bold text-blue-800 mb-2">üìß Preview Email Laporan Siswa</h1>
            <p class="text-blue-600">Preview email yang akan dikirim untuk laporan akademik siswa</p>
        </div>

        <!-- Email Metadata -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">Detail Email</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Kepada:</label>
                    <p class="mt-1 text-sm text-gray-900" th:text="${emailData.recipientName}">Recipient Name</p>
                    <p class="text-sm text-gray-500" th:text="${emailData.recipientEmail}">recipient@email.com</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Subjek:</label>
                    <p class="mt-1 text-sm text-gray-900" th:text="'Laporan Akademik - ' + ${emailData.studentName} + ' - ' + ${emailData.termName}">Subject</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nama Siswa:</label>
                    <p class="mt-1 text-sm text-gray-900" th:text="${emailData.studentName}">Student Name</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Periode:</label>
                    <p class="mt-1 text-sm text-gray-900" th:text="${emailData.termName}">Term Name</p>
                </div>
            </div>
        </div>

        <!-- Email Content Preview -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
            <div class="bg-gray-100 px-4 py-3 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">üìÑ Isi Email</h3>
            </div>
            <div class="p-6">
                <pre class="whitespace-pre-wrap text-sm text-gray-800 font-mono leading-relaxed" th:text="${emailContent}">Email content will appear here...</pre>
            </div>
        </div>

        <!-- Email Actions -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-green-800 mb-4">‚úâÔ∏è Kirim Email</h3>

            <form id="email-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="email-recipient" class="block text-sm font-medium text-gray-700">Email Penerima</label>
                        <input type="email"
                               id="email-recipient"
                               name="recipientEmail"
                               th:value="${emailData.recipientEmail}"
                               class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 shadow-sm focus:border-green-500 focus:ring-green-500"
                               required>
                    </div>
                    <div>
                        <label for="email-recipient-name" class="block text-sm font-medium text-gray-700">Nama Penerima</label>
                        <input type="text"
                               id="email-recipient-name"
                               name="recipientName"
                               th:value="${emailData.recipientName}"
                               class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 shadow-sm focus:border-green-500 focus:ring-green-500"
                               required>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" id="btn-send-email"
                            class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        <i class="fas fa-paper-plane mr-2"></i>Kirim Email
                    </button>
                    <a th:href="@{/reports/student/{id}(id=${emailData.studentName})}"
                       class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali ke Laporan
                    </a>
                </div>
            </form>

            <!-- Email Status Messages -->
            <div id="email-status" class="mt-4 hidden">
                <div id="email-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                    <i class="fas fa-check-circle mr-2"></i>Email berhasil dikirim!
                </div>
                <div id="email-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <i class="fas fa-exclamation-circle mr-2"></i>Gagal mengirim email. Silakan coba lagi.
                </div>
                <div id="email-validation-error" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Mohon periksa format email yang dimasukkan.
                </div>
            </div>
        </div>

    </div>

    <script>
        document.getElementById('email-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const submitButton = document.getElementById('btn-send-email');
            const statusDiv = document.getElementById('email-status');
            const successDiv = document.getElementById('email-success');
            const errorDiv = document.getElementById('email-error');
            const validationDiv = document.getElementById('email-validation-error');

            // Reset status
            statusDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            validationDiv.classList.add('hidden');

            // Disable button
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengirim...';

            // Get student ID from URL or a hidden field - for now use a placeholder
            const studentId = '[[${emailData.studentName}]]' || 'sample-id';

            fetch(`/reports/email/send/${studentId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                statusDiv.classList.remove('hidden');
                if (result === 'success') {
                    successDiv.classList.remove('hidden');
                } else {
                    errorDiv.classList.remove('hidden');
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>' + result;
                }
            })
            .catch(error => {
                statusDiv.classList.remove('hidden');
                errorDiv.classList.remove('hidden');
                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Terjadi kesalahan: ' + error.message;
            })
            .finally(() => {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Kirim Email';
            });
        });
    </script>
</body>
</html>