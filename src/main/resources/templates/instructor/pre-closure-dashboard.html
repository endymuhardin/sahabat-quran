<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Pre-Closure Dashboard</title>
    <style>
        .progress-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .progress-card.complete { border-left-color: #10b981; }
        .progress-card.incomplete { border-left-color: #f59e0b; }
        .progress-card.pending { border-left-color: #ef4444; }

        .completion-bar {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            overflow: hidden;
        }
        .completion-progress {
            height: 100%;
            transition: width 0.5s ease;
        }
        .completion-progress.high { background: #10b981; }
        .completion-progress.medium { background: #f59e0b; }
        .completion-progress.low { background: #ef4444; }

        .task-item {
            padding: 12px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .task-item:hover {
            background: #f9fafb;
            border-left-color: #3b82f6;
        }
        .urgency-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        .urgency-high { background: #fee2e2; color: #dc2626; }
        .urgency-medium { background: #fed7aa; color: #ea580c; }
        .urgency-low { background: #dbeafe; color: #2563eb; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1">Pre-Closure Dashboard</h2>
                        <p class="text-muted mb-0">Complete all tasks before semester closure</p>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold" th:text="${preClosureData.termName}">Semester 1 2024/2025</div>
                        <div class="text-muted">
                            <i class="bi bi-calendar-event"></i>
                            <span th:text="${preClosureData.daysUntilClosure}">5</span> days until closure
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert if not ready for closure -->
        <div th:if="${!preClosureData.readyForClosure}" class="alert alert-warning alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div>
                    <strong>Action Required!</strong>
                    You have pending tasks that must be completed before semester closure.
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Overall Progress Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Overall Completion Status</h5>
                        <div class="row g-3">
                            <!-- Grade Completion -->
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Grade Entry</span>
                                    <span class="fw-bold" th:text="${#numbers.formatDecimal(preClosureData.gradeCompletionPercentage, 0, 0) + '%'}">85%</span>
                                </div>
                                <div class="completion-bar">
                                    <div class="completion-progress"
                                         th:classappend="${preClosureData.gradeCompletionPercentage >= 100 ? 'high' : (preClosureData.gradeCompletionPercentage >= 50 ? 'medium' : 'low')}"
                                         th:style="'width: ' + ${preClosureData.gradeCompletionPercentage} + '%'"></div>
                                </div>
                                <div class="text-muted small mt-1">
                                    <span th:text="${preClosureData.classesWithCompleteGrades}">3</span> of
                                    <span th:text="${preClosureData.totalClasses}">4</span> classes complete
                                </div>
                            </div>

                            <!-- Attendance Verification -->
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Attendance Verification</span>
                                    <span class="fw-bold" th:text="${#numbers.formatDecimal(preClosureData.attendanceVerificationPercentage, 0, 0) + '%'}">100%</span>
                                </div>
                                <div class="completion-bar">
                                    <div class="completion-progress"
                                         th:classappend="${preClosureData.attendanceVerificationPercentage >= 100 ? 'high' : (preClosureData.attendanceVerificationPercentage >= 50 ? 'medium' : 'low')}"
                                         th:style="'width: ' + ${preClosureData.attendanceVerificationPercentage} + '%'"></div>
                                </div>
                                <div class="text-muted small mt-1">
                                    <span th:text="${preClosureData.classesWithVerifiedAttendance}">4</span> of
                                    <span th:text="${preClosureData.totalClasses}">4</span> classes verified
                                </div>
                            </div>

                            <!-- Evaluation Submission -->
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Class Evaluations</span>
                                    <span class="fw-bold" th:text="${#numbers.formatDecimal(preClosureData.evaluationCompletionPercentage, 0, 0) + '%'}">75%</span>
                                </div>
                                <div class="completion-bar">
                                    <div class="completion-progress"
                                         th:classappend="${preClosureData.evaluationCompletionPercentage >= 100 ? 'high' : (preClosureData.evaluationCompletionPercentage >= 50 ? 'medium' : 'low')}"
                                         th:style="'width: ' + ${preClosureData.evaluationCompletionPercentage} + '%'"></div>
                                </div>
                                <div class="text-muted small mt-1">
                                    <span th:text="${preClosureData.completedEvaluations}">3</span> of
                                    <span th:text="${preClosureData.totalClasses}">4</span> submitted
                                </div>
                            </div>
                        </div>

                        <!-- Overall Progress Bar -->
                        <div class="mt-4 pt-3 border-top">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold">Total Progress</span>
                                <span class="fw-bold text-primary"
                                      th:text="${#numbers.formatDecimal(preClosureData.overallCompletionPercentage, 0, 0) + '%'}">87%</span>
                            </div>
                            <div class="progress" style="height: 12px;">
                                <div class="progress-bar"
                                     th:classappend="${preClosureData.overallCompletionPercentage >= 100 ? 'bg-success' : (preClosureData.overallCompletionPercentage >= 75 ? 'bg-primary' : (preClosureData.overallCompletionPercentage >= 50 ? 'bg-warning' : 'bg-danger'))}"
                                     role="progressbar"
                                     th:style="'width: ' + ${preClosureData.overallCompletionPercentage} + '%'"
                                     th:attr="aria-valuenow=${preClosureData.overallCompletionPercentage}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Tasks -->
        <div class="row mb-4" th:if="${!#lists.isEmpty(preClosureData.pendingTasks)}">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-circle me-2"></i>Pending Tasks
                            <span class="badge bg-warning ms-2" th:text="${#lists.size(preClosureData.pendingTasks)}">3</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            <div th:each="task : ${preClosureData.pendingTasks}"
                                 class="list-group-item task-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="bi bi-chevron-right me-2 text-muted"></i>
                                            <span class="fw-semibold" th:text="${task.description}">Complete grade entry for 5 students</span>
                                            <span class="urgency-badge ms-2"
                                                  th:classappend="${'urgency-' + #strings.toLowerCase(task.urgency)}"
                                                  th:text="${task.urgency}">HIGH</span>
                                        </div>
                                        <div class="text-muted small ms-4">
                                            <i class="bi bi-book me-1"></i>
                                            <span th:text="${task.relatedClassName}">Class A - Level 1</span>
                                            <span class="mx-2">•</span>
                                            <i class="bi bi-calendar-check me-1"></i>
                                            Due: <span th:text="${#temporals.format(task.deadline, 'dd MMM yyyy')}">20 Dec 2024</span>
                                        </div>
                                    </div>
                                    <div>
                                        <button th:if="${task.taskType == 'GRADE_ENTRY'}"
                                                class="btn btn-sm btn-outline-primary"
                                                th:onclick="'location.href=\'/instructor/grades?classId=' + ${task.relatedClassId} + '\''">
                                            <i class="bi bi-pencil-square"></i> Enter Grades
                                        </button>
                                        <button th:if="${task.taskType == 'ATTENDANCE_VERIFICATION'}"
                                                class="btn btn-sm btn-outline-primary"
                                                th:onclick="'verifyAttendance(\'' + ${task.relatedClassId} + '\')'">
                                            <i class="bi bi-check-circle"></i> Verify
                                        </button>
                                        <button th:if="${task.taskType == 'EVALUATION_SUBMISSION'}"
                                                class="btn btn-sm btn-outline-primary"
                                                th:onclick="'location.href=\'/instructor/evaluation?classId=' + ${task.relatedClassId} + '\''">
                                            <i class="bi bi-clipboard-check"></i> Submit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Class Details -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Class-wise Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div th:each="classStatus : ${preClosureData.classStatuses}"
                                 class="col-md-6 col-lg-4">
                                <div class="card progress-card h-100"
                                     th:classappend="${classStatus.status == 'COMPLETE' ? 'complete' : (classStatus.status == 'INCOMPLETE' ? 'incomplete' : 'pending')}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h6 class="mb-1" th:text="${classStatus.className}">Class A</h6>
                                                <small class="text-muted" th:text="${classStatus.levelName}">Level 1</small>
                                            </div>
                                            <span class="badge"
                                                  th:classappend="${classStatus.status == 'COMPLETE' ? 'bg-success' : (classStatus.status == 'INCOMPLETE' ? 'bg-warning' : 'bg-danger')}"
                                                  th:text="${classStatus.status}">INCOMPLETE</span>
                                        </div>

                                        <!-- Class Metrics -->
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between small mb-2">
                                                <span class="text-muted">Students</span>
                                                <span th:text="${classStatus.totalStudents}">25</span>
                                            </div>
                                            <div class="d-flex justify-content-between small mb-2">
                                                <span class="text-muted">Sessions</span>
                                                <span th:text="${classStatus.totalSessions}">12</span>
                                            </div>
                                            <div class="d-flex justify-content-between small">
                                                <span class="text-muted">Completion</span>
                                                <span class="fw-bold"
                                                      th:text="${#numbers.formatDecimal(classStatus.completionPercentage, 0, 0) + '%'}">75%</span>
                                            </div>
                                        </div>

                                        <!-- Task Status Indicators -->
                                        <div class="d-flex justify-content-between small">
                                            <span th:classappend="${classStatus.gradesFinalized ? 'text-success' : 'text-danger'}">
                                                <i th:class="${classStatus.gradesFinalized ? 'bi bi-check-circle-fill' : 'bi bi-x-circle'}"></i>
                                                Grades
                                            </span>
                                            <span th:classappend="${classStatus.attendanceVerified ? 'text-success' : 'text-danger'}">
                                                <i th:class="${classStatus.attendanceVerified ? 'bi bi-check-circle-fill' : 'bi bi-x-circle'}"></i>
                                                Attendance
                                            </span>
                                            <span th:classappend="${classStatus.evaluationSubmitted ? 'text-success' : 'text-danger'}">
                                                <i th:class="${classStatus.evaluationSubmitted ? 'bi bi-check-circle-fill' : 'bi bi-x-circle'}"></i>
                                                Evaluation
                                            </span>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="mt-3 pt-3 border-top" th:if="${classStatus.status != 'COMPLETE'}">
                                            <div class="d-grid gap-2">
                                                <button th:if="${!classStatus.gradesFinalized}"
                                                        class="btn btn-sm btn-outline-primary"
                                                        th:onclick="'finalizeGrades(\'' + ${classStatus.classId} + '\')'">
                                                    Finalize Grades
                                                </button>
                                                <button th:if="${!classStatus.attendanceVerified}"
                                                        class="btn btn-sm btn-outline-primary"
                                                        th:onclick="'verifyAttendance(\'' + ${classStatus.classId} + '\')'">
                                                    Verify Attendance
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script th:inline="javascript">
        function finalizeGrades(classId) {
            if (!confirm('Are you sure you want to finalize grades for this class? This action cannot be undone.')) {
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/instructor/finalize-grades';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'classId';
            input.value = classId;

            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken.content;
                form.appendChild(csrfInput);
            }

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function verifyAttendance(classId) {
            if (!confirm('Please confirm that all attendance records for this class have been reviewed and are accurate.')) {
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/instructor/verify-attendance';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'classId';
            input.value = classId;

            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken.content;
                form.appendChild(csrfInput);
            }

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    </script>
</div>
</body>
</html>