<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title th:text="${pageTitle}">Feedback Form</title>
    <style>
        .rating-star {
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.15s;
        }
        .rating-star.active,
        .rating-star:hover {
            color: #fbbf24;
        }
        .rating-star:not(.active):not(:hover) {
            color: #d1d5db;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .question-progress-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: white;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
            font-size: 12px;
        }

        .question-progress-item.answered { border-color: #10b981; background: #f0fdf4; }
        .question-progress-item.saved { border-color: #3b82f6; background: #eff6ff; }
        .question-progress-item.saving { border-color: #f59e0b; background: #fffbeb; }
        .question-progress-item.error { border-color: #ef4444; background: #fef2f2; }

        .progress-question-number { font-weight: 600; margin-bottom: 4px; }
        .progress-status-icon { width: 16px; height: 16px; margin-bottom: 2px; }
        .progress-status-text { font-size: 10px; font-weight: 500; text-align: center; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container mx-auto px-4 py-8 max-w-4xl"
         x-data="feedbackForm"
         th:data-campaign-id="${campaign.campaignId}"
         th:data-total-questions="${campaign.totalQuestions}"
         th:data-resume-data="${resumeData != null ? resumeData : ''}">

        <!-- Header -->
        <div class="mb-6">
            <h1 id="feedback-form-title" class="text-2xl font-bold text-gray-900" th:text="${campaign.campaignName}">Teacher Evaluation</h1>
            <div id="anonymity-notice" class="flex items-center gap-4 mt-2">
                <span class="text-sm text-gray-600">
                    <i class="fas fa-user-secret text-blue-500 mr-1"></i>
                    Feedback Anda bersifat <strong>anonim</strong>
                </span>
                <span class="text-sm text-gray-600">
                    <i class="fas fa-clock text-gray-400 mr-1"></i>
                    Estimasi waktu: <span th:text="${campaign.estimatedTime}">15</span> menit
                </span>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div id="progress-indicator" class="mb-8">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-medium text-gray-700">Question Progress & Auto-save Status</h3>
                <div class="text-sm text-gray-600">
                    <span x-text="answeredCount">0</span>/<span th:text="${campaign.totalQuestions}">12</span> answered
                    (<span x-text="progressPercentage + '%'">0%</span>)
                </div>
            </div>

            <!-- Auto-save Status -->
            <div class="flex items-center gap-2 mb-3 text-sm">
                <template x-if="saveStatus === 'saving'">
                    <span class="text-yellow-600"><i class="fas fa-spinner fa-spin mr-1"></i>Menyimpan...</span>
                </template>
                <template x-if="saveStatus === 'saved'">
                    <span class="text-green-600"><i class="fas fa-check mr-1"></i>Tersimpan otomatis</span>
                </template>
                <template x-if="saveStatus === 'error'">
                    <span class="text-red-600"><i class="fas fa-exclamation-triangle mr-1"></i>Gagal menyimpan</span>
                </template>
            </div>

            <div id="questions-progress-grid" class="progress-grid">
                <div th:each="question, iterStat : ${campaign.questions}"
                     class="question-progress-item"
                     th:id="'progress-q' + ${iterStat.index + 1}"
                     th:data-question-id="${question.questionId}"
                     x-bind:class="getQuestionStatusClass('[[${question.questionId}]]')"
                     data-testid="question-progress">
                    <div class="progress-question-number" th:text="'Q' + ${iterStat.index + 1}">Q1</div>
                    <div class="progress-status-icon" x-text="getQuestionStatusIcon('[[${question.questionId}]]')"></div>
                    <div class="progress-status-text" x-text="getQuestionStatusText('[[${question.questionId}]]')">Not Started</div>
                </div>
            </div>
        </div>

        <!-- Resume Notice -->
        <div th:if="${resumeData != null and resumeData.canResume}"
             id="resume-notice"
             class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        Anda memiliki progress yang tersimpan.
                        <span th:text="${resumeData.completedQuestions}">5</span> dari
                        <span th:text="${campaign.totalQuestions}">12</span> pertanyaan sudah dijawab.
                    </p>
                </div>
            </div>
        </div>

        <!-- Feedback Form -->
        <form id="feedback-form"
              th:action="@{/student/feedback/campaign/{id}/submit(id=${campaign.campaignId})}"
              method="POST"
              x-on:submit="handleSubmit($event)">
            <input type="hidden" name="campaignId" th:value="${campaign.campaignId}"/>
            <input type="hidden" name="deviceInfo" id="device-info" x-bind:value="deviceInfo"/>

            <!-- Questions Container -->
            <div id="questions-container">
                <div id="question-categories">Categories present</div>
                <div th:each="question, iterStat : ${campaign.questions}"
                     class="question-card bg-white rounded-lg shadow p-6 mb-6"
                     th:data-question-id="${question.questionId}"
                     th:id="'question-card-' + ${question.questionId}">

                    <div class="mb-4">
                        <div class="flex justify-between items-start">
                            <label class="block text-gray-700 font-medium mb-2">
                                <span class="text-sm text-gray-500">Pertanyaan <span th:text="${iterStat.index + 1}">1</span></span>
                                <span th:if="${question.isRequired}" class="text-red-500 ml-1">*</span>
                            </label>
                            <span th:if="${question.category}" class="text-xs bg-gray-100 px-2 py-1 rounded"
                                  th:text="${question.category}">Teaching Quality</span>
                        </div>
                        <p class="text-gray-900" th:text="${question.questionText}">
                            Bagaimana kualitas pengajaran ustadz?
                        </p>
                    </div>

                    <!-- Rating Question -->
                    <div th:if="${question.questionType == 'RATING'}" class="rating-container">
                        <div class="flex gap-2 justify-center">
                            <span th:each="star : ${#numbers.sequence(1, 5)}"
                                  class="rating-star"
                                  th:data-rating="${star}"
                                  th:data-question="${question.questionId}"
                                  th:id="'rating-star-' + ${question.questionId} + '-' + ${star}"
                                  x-on:click="setRating('[[${question.questionId}]]', [[${star}]])"
                                  x-on:mouseenter="hoverRating['[[${question.questionId}]]'] = [[${star}]]"
                                  x-on:mouseleave="hoverRating['[[${question.questionId}]]'] = 0"
                                  x-bind:class="{ 'active': isStarActive('[[${question.questionId}]]', [[${star}]]) }">
                                <i class="fas fa-star"></i>
                            </span>
                        </div>
                        <input type="hidden"
                               th:name="'answers[' + ${iterStat.index} + '].rating'"
                               th:id="'rating-' + ${question.questionId}"
                               x-bind:value="answers['[[${question.questionId}]]']?.rating || ''"
                               class="rating-input"/>
                        <input type="hidden"
                               th:name="'answers[' + ${iterStat.index} + '].questionId'"
                               th:value="${question.questionId}"/>
                        <div class="text-center mt-2 text-sm text-gray-500">
                            <span x-text="getRatingText('[[${question.questionId}]]')">Klik untuk memberi rating</span>
                        </div>
                    </div>

                    <!-- Yes/No Question -->
                    <div th:if="${question.questionType == 'YES_NO'}" class="yes-no-container">
                        <div class="flex gap-4 justify-center">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio"
                                       th:name="'answers[' + ${iterStat.index} + '].yesNo'"
                                       th:id="'yes-option-' + ${question.questionId}"
                                       value="true"
                                       class="mr-2"
                                       x-on:change="setYesNo('[[${question.questionId}]]', true)"/>
                                <span>Ya</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio"
                                       th:name="'answers[' + ${iterStat.index} + '].yesNo'"
                                       th:id="'no-option-' + ${question.questionId}"
                                       value="false"
                                       class="mr-2"
                                       x-on:change="setYesNo('[[${question.questionId}]]', false)"/>
                                <span>Tidak</span>
                            </label>
                        </div>
                        <input type="hidden"
                               th:name="'answers[' + ${iterStat.index} + '].questionId'"
                               th:value="${question.questionId}"/>
                    </div>

                    <!-- Text Question -->
                    <div th:if="${question.questionType == 'TEXT'}" class="text-container">
                        <textarea th:name="'answers[' + ${iterStat.index} + '].answerText'"
                                  th:id="'text-answer-' + ${question.questionId}"
                                  rows="4"
                                  maxlength="500"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Tulis jawaban Anda di sini..."
                                  th:data-question="${question.questionId}"
                                  x-on:input="setText('[[${question.questionId}]]', $event.target.value)"
                                  x-bind:value="answers['[[${question.questionId}]]']?.text || ''"></textarea>
                        <div class="text-right mt-1 text-xs"
                             x-bind:class="{ 'text-red-500': getCharCount('[[${question.questionId}]]') > 450, 'text-gray-500': getCharCount('[[${question.questionId}]]') <= 450 }">
                            <span x-text="getCharCount('[[${question.questionId}]]')">0</span>/500 karakter
                        </div>
                        <input type="hidden"
                               th:name="'answers[' + ${iterStat.index} + '].questionId'"
                               th:value="${question.questionId}"/>
                    </div>

                    <!-- Multiple Choice Question -->
                    <div th:if="${question.questionType == 'MULTIPLE_CHOICE'}" class="multiple-choice-container">
                        <div class="space-y-2">
                            <label th:each="option, optionStat : ${question.options}" class="flex items-center cursor-pointer">
                                <input type="radio"
                                       th:name="'answers[' + ${iterStat.index} + '].selectedOption'"
                                       th:id="'option-' + ${question.questionId} + '-' + ${optionStat.index}"
                                       th:value="${option}"
                                       class="mr-2"
                                       x-on:change="setChoice('[[${question.questionId}]]', '[[${option}]]')"/>
                                <span th:text="${option}">Option</span>
                            </label>
                        </div>
                        <input type="hidden"
                               th:name="'answers[' + ${iterStat.index} + '].questionId'"
                               th:value="${question.questionId}"/>
                    </div>
                </div>
            </div>

            <!-- Validation Error Message -->
            <div id="validation-error"
                 x-show="showValidationError"
                 x-transition
                 class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">
                            Mohon jawab semua pertanyaan yang wajib diisi (ditandai dengan *)
                        </p>
                    </div>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center">
                    <button type="button"
                            id="save-draft-btn"
                            x-on:click="saveDraft()"
                            x-bind:disabled="saveStatus === 'saving'"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-6 rounded transition-colors disabled:opacity-50">
                        <i class="fas fa-save mr-2"></i>Simpan Draft
                    </button>
                    <button type="submit"
                            id="submit-btn"
                            x-bind:disabled="saveStatus === 'saving'"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded transition-colors disabled:opacity-50">
                        <i class="fas fa-paper-plane mr-2"></i>Kirim Feedback
                    </button>
                </div>
            </div>
        </form>

        <!-- Confirmation Modal -->
        <div x-show="showConfirmModal"
             x-transition
             class="fixed inset-0 z-50 overflow-y-auto"
             style="display: none;">
            <div class="fixed inset-0 bg-gray-600 bg-opacity-50" x-on:click="showConfirmModal = false"></div>
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg font-medium text-gray-900">Konfirmasi Pengiriman</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-user-secret mr-2"></i>
                            Feedback Anda akan dikirim secara anonim. Apakah Anda yakin ingin mengirim?
                        </p>
                    </div>
                    <div class="items-center px-4 py-3 flex justify-center gap-2">
                        <button x-on:click="confirmSubmit()"
                                class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-base font-medium rounded-md">
                            Ya, Kirim
                        </button>
                        <button x-on:click="showConfirmModal = false"
                                class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white text-base font-medium rounded-md">
                            Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="javascript">
<script th:inline="javascript">
    document.addEventListener('alpine:init', () => {
        Alpine.data('feedbackForm', function() {
            return {
                campaignId: this.$el.dataset.campaignId,
                totalQuestions: parseInt(this.$el.dataset.totalQuestions) || 0,
                answers: {},
                hoverRating: {},
                questionStatus: {},
                saveStatus: 'idle',
                saveTimer: null,
                showValidationError: false,
                showConfirmModal: false,
                deviceInfo: navigator.userAgent,

                init() {
                    // Initialize from resume data if available
                    const resumeDataStr = this.$el.dataset.resumeData;
                    if (resumeDataStr) {
                        try {
                            const resumeData = JSON.parse(resumeDataStr);
                            if (resumeData && resumeData.canResume && resumeData.savedAnswers) {
                                Object.entries(resumeData.savedAnswers).forEach(([questionId, answer]) => {
                                    this.answers[questionId] = answer;
                                    this.questionStatus[questionId] = 'answered';
                                });
                            }
                        } catch (e) {
                            console.log('No resume data to parse');
                        }
                    }
                },

                get answeredCount() {
                    return Object.keys(this.answers).filter(qId => {
                        const a = this.answers[qId];
                        return a && (a.rating || a.yesNo !== undefined || a.text || a.choice);
                    }).length;
                },

                get progressPercentage() {
                    return this.totalQuestions > 0 ? Math.round((this.answeredCount / this.totalQuestions) * 100) : 0;
                },

                setRating(questionId, rating) {
                    if (!this.answers[questionId]) this.answers[questionId] = {};
                    this.answers[questionId].rating = rating;
                    this.questionStatus[questionId] = 'answered';
                    this.triggerAutoSave();
                },

                setYesNo(questionId, value) {
                    if (!this.answers[questionId]) this.answers[questionId] = {};
                    this.answers[questionId].yesNo = value;
                    this.questionStatus[questionId] = 'answered';
                    this.triggerAutoSave();
                },

                setText(questionId, value) {
                    if (!this.answers[questionId]) this.answers[questionId] = {};
                    this.answers[questionId].text = value;
                    if (value.trim()) {
                        this.questionStatus[questionId] = 'answered';
                    } else {
                        delete this.questionStatus[questionId];
                    }
                    this.triggerAutoSave();
                },

                setChoice(questionId, value) {
                    if (!this.answers[questionId]) this.answers[questionId] = {};
                    this.answers[questionId].choice = value;
                    this.questionStatus[questionId] = 'answered';
                    this.triggerAutoSave();
                },

                isStarActive(questionId, star) {
                    const hover = this.hoverRating[questionId] || 0;
                    const rating = this.answers[questionId]?.rating || 0;
                    return star <= (hover || rating);
                },

                getRatingText(questionId) {
                    const rating = this.answers[questionId]?.rating;
                    if (!rating) return 'Klik untuk memberi rating';
                    const texts = ['', 'Sangat Buruk', 'Buruk', 'Cukup', 'Baik', 'Sangat Baik'];
                    return texts[rating] || '';
                },

                getCharCount(questionId) {
                    return (this.answers[questionId]?.text || '').length;
                },

                getQuestionStatusClass(questionId) {
                    const status = this.questionStatus[questionId];
                    return {
                        'answered': status === 'answered',
                        'saved': status === 'saved',
                        'saving': status === 'saving',
                        'error': status === 'error'
                    };
                },

                getQuestionStatusIcon(questionId) {
                    const status = this.questionStatus[questionId];
                    switch (status) {
                        case 'answered': return 'âœ“';
                        case 'saved': return 'ðŸ’¾';
                        case 'saving': return 'â³';
                        case 'error': return 'âŒ';
                        default: return 'âšª';
                    }
                },

                getQuestionStatusText(questionId) {
                    const status = this.questionStatus[questionId];
                    switch (status) {
                        case 'answered': return 'Answered';
                        case 'saved': return 'Auto-saved';
                        case 'saving': return 'Saving...';
                        case 'error': return 'Save Failed';
                        default: return 'Not Started';
                    }
                },

                triggerAutoSave() {
                    clearTimeout(this.saveTimer);
                    this.saveTimer = setTimeout(() => this.autoSave(), 2000);
                },

                async autoSave() {
                    this.saveStatus = 'saving';

                    // Mark questions as saving
                    Object.keys(this.answers).forEach(qId => {
                        if (this.questionStatus[qId]) {
                            this.questionStatus[qId] = 'saving';
                        }
                    });

                    const partialAnswers = [];
                    Object.entries(this.answers).forEach(([questionId, answer]) => {
                        if (answer.rating || answer.yesNo !== undefined || answer.text || answer.choice) {
                            partialAnswers.push({
                                questionId: questionId,
                                rating: answer.rating || null,
                                answerText: answer.text || (answer.yesNo !== undefined ? String(answer.yesNo) : null) || answer.choice || null
                            });
                        }
                    });

                    try {
                        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
                        const response = await fetch(`/student/feedback/campaign/${this.campaignId}/autosave`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken
                            },
                            body: JSON.stringify({
                                campaignId: this.campaignId,
                                partialAnswers: partialAnswers,
                                currentQuestionIndex: this.answeredCount
                            })
                        });

                        if (response.ok) {
                            this.saveStatus = 'saved';
                            Object.keys(this.answers).forEach(qId => {
                                if (this.questionStatus[qId] === 'saving') {
                                    this.questionStatus[qId] = 'saved';
                                }
                            });
                            setTimeout(() => {
                                if (this.saveStatus === 'saved') this.saveStatus = 'idle';
                            }, 3000);
                        } else {
                            throw new Error('Save failed');
                        }
                    } catch (e) {
                        this.saveStatus = 'error';
                        Object.keys(this.answers).forEach(qId => {
                            if (this.questionStatus[qId] === 'saving') {
                                this.questionStatus[qId] = 'error';
                            }
                        });
                    }
                },

                saveDraft() {
                    this.autoSave();
                },

                handleSubmit(event) {
                    clearTimeout(this.saveTimer);

                    // Check required questions
                    const requiredCards = document.querySelectorAll('.question-card:has(span.text-red-500)');
                    let hasUnanswered = false;

                    requiredCards.forEach(card => {
                        const questionId = card.dataset.questionId;
                        const answer = this.answers[questionId];
                        if (!answer || (!answer.rating && answer.yesNo === undefined && !answer.text && !answer.choice)) {
                            hasUnanswered = true;
                            card.style.border = '2px solid red';
                            setTimeout(() => card.style.border = '', 5000);
                        }
                    });

                    if (hasUnanswered) {
                        event.preventDefault();
                        this.showValidationError = true;
                        document.getElementById('validation-error').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => this.showValidationError = false, 5000);
                    }
                },

                confirmSubmit() {
                    this.showConfirmModal = false;
                    document.getElementById('feedback-form').submit();
                }
            };
        });
    });
</script>
</th:block>
</body>
</html>
