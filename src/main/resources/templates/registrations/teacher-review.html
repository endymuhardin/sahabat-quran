<!DOCTYPE html>
<html lang="id" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title>Review Registrasi - Sahabat Quran</title>
</head>
<body>
<div layout:fragment="content">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h2 id="page-title" class="text-2xl font-bold text-gray-900">Review Registrasi Siswa</h2>
                    <p id="page-subtitle" class="text-gray-600 mt-1">Evaluasi dan berikan rekomendasi untuk siswa</p>
                </div>
                <div>
                    <a th:href="@{/registrations/assigned}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" id="back-btn">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali ke Daftar
                    </a>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        <div th:if="${successMessage}" id="success-alert" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4 flex items-center" role="alert">
            <i class="fas fa-check-circle mr-2"></i>
            <span th:text="${successMessage}">Success message</span>
            <button type="button" class="ml-auto text-green-700 hover:text-green-900" onclick="this.parentElement.style.display='none'" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div th:if="${errorMessage}" id="error-alert" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4 flex items-center" role="alert">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span th:text="${errorMessage}">Error message</span>
            <button type="button" class="ml-auto text-red-700 hover:text-red-900" onclick="this.parentElement.style.display='none'" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Global Form Validation Errors -->
        <div th:if="${globalErrors != null and !#lists.isEmpty(globalErrors)}" id="global-errors" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
            <div class="flex items-center mb-2">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <h5 class="font-medium">Please correct the following errors:</h5>
            </div>
            <ul class="list-disc list-inside space-y-1">
                <li th:each="error : ${globalErrors}" th:text="${error}">Global error message</li>
            </ul>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Student Information -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Personal Information Card -->
                <div class="bg-white shadow rounded-lg" id="student-info-card">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h5 class="text-lg font-medium text-gray-900 flex items-center">
                            <i class="fas fa-user mr-2"></i>Informasi Siswa
                        </h5>
                    </div>
                    <div class="px-6 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <div class="space-y-3">
                                    <div class="flex">
                                        <span class="font-medium text-gray-700 w-32">Nama Lengkap:</span>
                                        <span id="student-name" class="text-gray-900" th:text="${registration.fullName}">Ahmad Zaki Mubarak</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-medium text-gray-700 w-32">Email:</span>
                                        <span id="student-email" class="text-gray-900" th:text="${registration.email}">ahmad.zaki@email.com</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-medium text-gray-700 w-32">Nomor HP:</span>
                                        <span id="student-phone" class="text-gray-900" th:text="${registration.phoneNumber}">081234567890</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-medium text-gray-700 w-32">Tanggal Lahir:</span>
                                        <span id="student-dob" class="text-gray-900" th:text="${#temporals.format(registration.dateOfBirth, 'dd/MM/yyyy')}">01/01/1995</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="space-y-3">
                                    <div class="flex">
                                        <span class="font-medium text-gray-700 w-32">Pendidikan:</span>
                                        <span id="student-education" class="text-gray-900" th:text="${registration.educationLevel}">Sarjana</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-medium text-gray-700 w-32">Sekolah/Univ:</span>
                                        <span id="student-school" class="text-gray-900" th:text="${registration.schoolName ?: '-'}">Universitas Indonesia</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-medium text-gray-700 w-32">Program:</span>
                                        <span id="student-program">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" th:text="${registration.program?.name}">Tahsin 1</span>
                                        </span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-medium text-gray-700 w-32">Status:</span>
                                        <span id="student-status">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" th:text="${registration.registrationStatus?.name()}">ASSIGNED</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Learning Background Card -->
                <div class="card mb-4" id="learning-background-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-book-open me-2"></i>Latar Belakang Belajar
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <h6>Pengalaman Membaca Al-Quran:</h6>
                                <p id="quran-experience" class="text-muted" th:text="${registration.quranReadingExperience ?: '-'}">
                                    Sudah bisa membaca Al-Quran sejak kecil, namun merasa perlu perbaikan makhorijul huruf
                                </p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6>Pengalaman Tahsin Sebelumnya:</h6>
                                <p id="tahsin-experience">
                                    <span th:if="${registration.previousTahsinExperience}" class="text-success">
                                        <i class="fas fa-check me-1"></i>Pernah
                                    </span>
                                    <span th:if="${!registration.previousTahsinExperience}" class="text-muted">
                                        <i class="fas fa-times me-1"></i>Belum Pernah
                                    </span>
                                </p>
                                <p th:if="${registration.previousTahsinDetails}" 
                                   id="tahsin-details" class="text-muted small" 
                                   th:text="${registration.previousTahsinDetails}">
                                    Detail pengalaman tahsin sebelumnya...
                                </p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6>Alasan Mendaftar:</h6>
                                <p id="registration-reason" class="text-muted" th:text="${registration.registrationReason ?: '-'}">
                                    Ingin memperbaiki bacaan Al-Quran dan mempersiapkan diri untuk tahfidz
                                </p>
                            </div>
                            <div class="col-12">
                                <h6>Tujuan Pembelajaran:</h6>
                                <p id="learning-goals" class="text-muted" th:text="${registration.learningGoals ?: '-'}">
                                    Menguasai tajwid dengan baik dan bisa membaca dengan fasih
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Placement Test Card -->
                <div class="card mb-4" id="placement-test-card" th:if="${registration.placementTest != null}">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-headphones me-2"></i>Tes Penempatan
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Ayat untuk Dibaca:</h6>
                                <div class="bg-light p-3 rounded mb-3" id="test-verse">
                                    <h6 class="text-primary" th:text="${registration.placementTest.surahName + ' : ' + registration.placementTest.ayahStart + '-' + registration.placementTest.ayahEnd}">
                                        Al-Fatiha : 1-7
                                    </h6>
                                    <div class="arabic-text fs-4 text-end mb-2" dir="rtl" 
                                         th:text="${registration.placementTest.arabicText}">
                                        بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <span th:if="${registration.placementTest.difficultyLevel <= 2}"
                                          class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"
                                          th:text="'Level ' + ${registration.placementTest.difficultyLevel}">
                                        Level 1
                                    </span>
                                    <span th:if="${registration.placementTest.difficultyLevel > 2 && registration.placementTest.difficultyLevel <= 4}"
                                          class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"
                                          th:text="'Level ' + ${registration.placementTest.difficultyLevel}">
                                        Level 3
                                    </span>
                                    <span th:if="${registration.placementTest.difficultyLevel > 4}"
                                          class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"
                                          th:text="'Level ' + ${registration.placementTest.difficultyLevel}">
                                        Level 5
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Rekaman Bacaan:</h6>
                                <div th:if="${registration.placementTest.recordingDriveLink != null}">
                                    <a th:href="${registration.placementTest.recordingDriveLink}" 
                                       target="_blank" 
                                       class="btn btn-primary btn-lg w-100 mb-3"
                                       id="play-recording-btn">
                                        <i class="fas fa-play me-2"></i>Putar Rekaman
                                    </a>
                                    <p class="small text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Rekaman akan dibuka di tab baru. Dengarkan dengan seksama untuk memberikan evaluasi yang akurat.
                                    </p>
                                </div>
                                <div th:if="${registration.placementTest.recordingDriveLink == null}" class="text-center py-4">
                                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                    <h6 class="text-warning">Rekaman Belum Tersedia</h6>
                                    <p class="text-muted">Siswa belum mengupload rekaman tes penempatan</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Form -->
            <div class="lg:col-span-1">
                <div class="bg-white shadow rounded-lg sticky top-8" id="review-form-card">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h5 class="text-lg font-medium text-gray-900 flex items-center">
                            <i class="fas fa-edit mr-2"></i>Form Evaluasi
                        </h5>
                    </div>
                    <form th:action="@{/registrations/assigned/{id}/review(id=${registration.id})}" method="post" 
                          th:object="${reviewRequest}" id="teacher-review-form">
                        <!-- Hidden fields required for TeacherReviewRequest -->
                        <input type="hidden" th:field="*{registrationId}" />
                        <input type="hidden" th:field="*{teacherId}" />
                        <div class="px-6 py-4">
                            <div class="mb-6">
                                <label for="reviewStatus" class="block text-sm font-medium text-gray-700 mb-2">Status Review <span class="text-red-500">*</span></label>
                                <select class="block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" 
                                        id="reviewStatus" th:field="*{reviewStatus}"
                                        th:class="${#fields.hasErrors('reviewStatus')} ? 'border-red-500 bg-red-50' : 'border-gray-300'">
                                    <option value="">-- Pilih Status --</option>
                                    <option value="IN_REVIEW">Sedang Direview (Draft)</option>
                                    <option value="COMPLETED">Selesai (Final)</option>
                                </select>
                                <!-- Field-specific validation error from server -->
                                <p th:if="${#fields.hasErrors('reviewStatus')}" th:errors="*{reviewStatus}" 
                                   class="mt-1 text-sm text-red-600" id="reviewStatus-error">
                                    Status review wajib dipilih
                                </p>
                                <!-- Client-side validation error (initially hidden) -->
                                <p class="mt-1 text-sm text-red-600 hidden" id="reviewStatus-error-client">
                                    Status review wajib dipilih
                                </p>
                            </div>

                            <div class="mb-6">
                                <label for="teacherRemarks" class="block text-sm font-medium text-gray-700 mb-2">Catatan Evaluasi <span class="text-red-500">*</span></label>
                                <textarea class="block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" 
                                          id="teacherRemarks" th:field="*{teacherRemarks}" 
                                          rows="5"
                                          th:class="${#fields.hasErrors('teacherRemarks')} ? 'border-red-500 bg-red-50' : 'border-gray-300'"
                                          placeholder="Berikan evaluasi detail tentang bacaan siswa, kelebihan, kekurangan, dan saran perbaikan...">
                                </textarea>
                                <div class="text-sm text-gray-600 mt-1">
                                    Minimal 10 karakter. Berikan evaluasi yang konstruktif dan detail.
                                </div>
                                <!-- Field-specific validation error from server -->
                                <p th:if="${#fields.hasErrors('teacherRemarks')}" th:errors="*{teacherRemarks}" 
                                   class="mt-1 text-sm text-red-600" id="teacherRemarks-error">
                                    Catatan evaluasi minimal 10 karakter
                                </p>
                                <!-- Client-side validation error (initially hidden) -->
                                <p class="mt-1 text-sm text-red-600 hidden" id="teacherRemarks-error-client">
                                    Catatan evaluasi minimal 10 karakter
                                </p>
                            </div>

                            <div class="mb-6">
                                <label for="recommendedLevelId" class="block text-sm font-medium text-gray-700 mb-2">Level yang Direkomendasikan</label>
                                <select class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" id="recommendedLevelId" th:field="*{recommendedLevelId}">
                                    <option value="">-- Pilih Level --</option>
                                    <option th:each="level : ${availableLevels}"
                                            th:value="${level.id}"
                                            th:text="${level.name}">Tahsin 1</option>
                                </select>
                                <div class="form-text">
                                    Pilih level yang sesuai dengan kemampuan siswa berdasarkan evaluasi Anda
                                </div>
                            </div>

                            <!-- Placement Test Evaluation (if available) -->
                            <div th:if="${registration.placementTest != null}" class="border-top pt-3">
                                <h6 class="mb-3">Evaluasi Tes Penempatan</h6>
                                
                                <div class="mb-3">
                                    <label for="placementTestResult" class="form-label">Hasil Tes (Skor 1-6)</label>
                                    <select class="form-select" id="placementTestResult" th:field="*{placementTestResult}">
                                        <option value="">-- Pilih Skor --</option>
                                        <option value="1">1 - Pemula</option>
                                        <option value="2">2 - Dasar</option>
                                        <option value="3">3 - Menengah Bawah</option>
                                        <option value="4">4 - Menengah</option>
                                        <option value="5">5 - Menengah Atas</option>
                                        <option value="6">6 - Mahir</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="placementNotes" class="form-label">Catatan Tes Penempatan</label>
                                    <textarea class="form-control" id="placementNotes" th:field="*{placementNotes}" 
                                              rows="3"
                                              placeholder="Catatan khusus tentang hasil tes penempatan..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                            <div class="space-y-3">
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" id="submit-review-btn">
                                    <i class="fas fa-paper-plane mr-2"></i>Submit Review
                                </button>
                                <button type="button" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="save-draft-btn">
                                    <i class="fas fa-save mr-2"></i>Simpan Draft
                                </button>
                            </div>
                            <div class="mt-2 text-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Review yang sudah di-submit tidak dapat diubah
                                </small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="javascript" th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('teacher-review-form');
    const reviewStatus = document.getElementById('reviewStatus');
    const teacherRemarks = document.getElementById('teacherRemarks');
    const submitBtn = document.getElementById('submit-review-btn');
    const saveDraftBtn = document.getElementById('save-draft-btn');

    // Form validation
    form.addEventListener('submit', function(e) {
        let isValid = true;

        // Reset validation states
        [reviewStatus, teacherRemarks].forEach(field => {
            field.classList.remove('is-invalid', 'border-red-500', 'bg-red-50');
            field.classList.add('border-gray-300');
        });
        document.getElementById('reviewStatus-error-client').classList.add('hidden');
        document.getElementById('teacherRemarks-error-client').classList.add('hidden');

        // Clear any existing recommended level validation
        const recommendedLevel = document.getElementById('recommendedLevelId');
        recommendedLevel.classList.remove('is-invalid', 'border-red-500');
        const existingRecommendedError = recommendedLevel.parentElement.querySelector('.invalid-feedback, .recommended-level-error');
        if (existingRecommendedError) {
            existingRecommendedError.remove();
        }

        // Validate review status
        if (!reviewStatus.value) {
            reviewStatus.classList.add('is-invalid', 'border-red-500', 'bg-red-50');
            reviewStatus.classList.remove('border-gray-300');
            document.getElementById('reviewStatus-error-client').classList.remove('hidden');
            isValid = false;
        }

        // Validate teacher remarks (minimum 10 characters)
        if (!teacherRemarks.value || teacherRemarks.value.trim().length < 10) {
            teacherRemarks.classList.add('is-invalid', 'border-red-500', 'bg-red-50');
            teacherRemarks.classList.remove('border-gray-300');
            document.getElementById('teacherRemarks-error-client').classList.remove('hidden');
            isValid = false;
        }

        // If status is COMPLETED, require recommended level
        if (reviewStatus.value === 'COMPLETED') {
            if (!recommendedLevel.value) {
                recommendedLevel.classList.add('is-invalid', 'border-red-500');
                isValid = false;
                
                // Add validation message
                const feedback = document.createElement('p');
                feedback.className = 'mt-1 text-sm text-red-600 recommended-level-error';
                feedback.textContent = 'Level rekomendasi wajib dipilih untuk review yang selesai';
                recommendedLevel.parentElement.appendChild(feedback);
            }
        }

        if (!isValid) {
            // Scroll to first error field
            const firstErrorField = document.querySelector('.is-invalid');
            if (firstErrorField) {
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstErrorField.focus();
            }
            
            e.preventDefault();
            return false;
        }
    });

    // Save draft functionality
    saveDraftBtn.addEventListener('click', function(e) {
        reviewStatus.value = 'IN_REVIEW';
        form.submit();
    });

    // Character count for remarks
    teacherRemarks.addEventListener('input', function() {
        const length = this.value.length;
        let feedback = this.parentElement.querySelector('.char-count');
        
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'char-count form-text';
            this.parentElement.appendChild(feedback);
        }
        
        feedback.textContent = `${length} karakter`;
        feedback.className = length >= 10 ? 'char-count form-text text-success' : 'char-count form-text text-muted';
    });

    // Auto-save draft every 2 minutes (if in draft mode)
    let autoSaveInterval;
    reviewStatus.addEventListener('change', function() {
        if (this.value === 'IN_REVIEW') {
            // Start auto-save for drafts
            autoSaveInterval = setInterval(function() {
                if (teacherRemarks.value.trim().length >= 10) {
                    // Auto-save logic could be implemented here
                    console.log('Auto-saving draft...');
                }
            }, 120000); // 2 minutes
        } else {
            // Stop auto-save for final submission
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
        }
    });
    
    // Trigger initial character count
    teacherRemarks.dispatchEvent(new Event('input'));
});
</script>
</body>
</html>