<!DOCTYPE html>
<html lang="id"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title>Kelola Registrasi - Sahabat Quran</title>
</head>
<body>
<div layout:fragment="content">
    <div class="max-w-7xl mx-auto px-4 py-6" x-data="assignModal">
        <!-- Header Section -->
        <div class="mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 id="page-title" class="text-2xl font-bold text-gray-900">Kelola Registrasi</h2>
                    <p id="page-subtitle" class="text-gray-600 mt-1">Kelola dan tugaskan registrasi siswa kepada guru</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="bg-white rounded-lg shadow-md mb-6" id="search-card">
            <div class="px-6 py-4 border-b border-gray-200">
                <h5 id="search-title" class="text-lg font-medium text-gray-900">
                    <i class="fas fa-search mr-2"></i>Pencarian & Filter
                </h5>
            </div>
            <div class="px-6 py-4">
                <form id="search-form"
                      hx-get="/registrations"
                      hx-target="#table-content"
                      hx-swap="outerHTML"
                      hx-push-url="true"
                      hx-indicator="#search-indicator">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa</label>
                            <input type="text"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                   id="fullName"
                                   name="fullName"
                                   th:value="${searchRequest?.fullName}"
                                   placeholder="Cari nama..."
                                   hx-get="/registrations"
                                   hx-target="#table-content"
                                   hx-swap="outerHTML"
                                   hx-trigger="keyup changed delay:500ms"
                                   hx-include="#search-form"
                                   hx-indicator="#search-indicator">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                   id="email"
                                   name="email"
                                   th:value="${searchRequest?.email}"
                                   placeholder="Cari email..."
                                   hx-get="/registrations"
                                   hx-target="#table-content"
                                   hx-swap="outerHTML"
                                   hx-trigger="keyup changed delay:500ms"
                                   hx-include="#search-form"
                                   hx-indicator="#search-indicator">
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    id="status"
                                    name="status"
                                    hx-get="/registrations"
                                    hx-target="#table-content"
                                    hx-swap="outerHTML"
                                    hx-trigger="change"
                                    hx-include="#search-form"
                                    hx-indicator="#search-indicator">
                                <option value="">Semua Status</option>
                                <option th:each="s : ${statusOptions}"
                                        th:value="${s}"
                                        th:text="${s.name()}"
                                        th:selected="${searchRequest?.registrationStatus == s}"></option>
                            </select>
                        </div>
                        <div>
                            <label for="program" class="block text-sm font-medium text-gray-700 mb-1">Program</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    id="program"
                                    name="programId"
                                    hx-get="/registrations"
                                    hx-target="#table-content"
                                    hx-swap="outerHTML"
                                    hx-trigger="change"
                                    hx-include="#search-form"
                                    hx-indicator="#search-indicator">
                                <option value="">Semua Program</option>
                                <option th:each="p : ${programs}"
                                        th:value="${p.id}"
                                        th:text="${p.name}"
                                        th:selected="${searchRequest?.programId == p.id}"></option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition-colors duration-200" id="search-btn">
                                <span id="search-indicator" class="htmx-indicator">
                                    <i class="fas fa-spinner fa-spin mr-1"></i>
                                </span>
                                <i class="fas fa-search mr-1"></i>Cari
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div class="bg-white rounded-lg shadow-md" id="results-card">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h5 id="results-title" class="text-lg font-medium text-gray-900">
                    <i class="fas fa-list mr-2"></i>Daftar Registrasi
                    <span th:replace="~{registrations/fragments :: results-count}"></span>
                </h5>
            </div>

            <div class="px-6 py-4">
                <!-- Results table loaded via htmx or initial render -->
                <div th:replace="~{registrations/fragments :: table-content}"></div>
            </div>
        </div>

        <!-- Assign Teacher Modal -->
        <div id="assignTeacherModal"
             x-show="open"
             class="fixed inset-0 z-50 overflow-y-auto"
             style="display: none;">

            <!-- Backdrop -->
            <div x-show="open"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 bg-gray-600 bg-opacity-50"
                 x-on:click="closeModal">
            </div>

            <!-- Modal Panel -->
            <div x-show="open"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="modal-content relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <i class="fas fa-user-plus text-green-600"></i>
                    </div>
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Tugaskan Guru</h3>
                        <div class="mt-4">
                            <form id="assignTeacherForm">
                                <input type="hidden" id="registrationId" name="registrationId" x-bind:value="registrationId">

                                <div class="mb-4 text-left">
                                    <label for="teacherId" class="block text-sm font-medium text-gray-700 mb-2">Pilih Guru</label>
                                    <select id="teacherId"
                                            name="teacherId"
                                            x-model="teacherId"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">Pilih guru...</option>
                                        <option th:each="teacher : ${teachers}" th:value="${teacher.id}" th:text="${teacher.fullName}">Guru</option>
                                    </select>
                                    <p x-show="!teacherId && showError" class="mt-1 text-sm text-red-600">Silakan pilih guru</p>
                                </div>

                                <div class="mb-4 text-left">
                                    <label for="assignmentNotes" class="block text-sm font-medium text-gray-700 mb-2">Catatan (Opsional)</label>
                                    <textarea id="assignmentNotes"
                                              name="assignmentNotes"
                                              rows="3"
                                              x-model="notes"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                              placeholder="Catatan untuk guru..."></textarea>
                                </div>

                                <div class="flex space-x-3">
                                    <button type="button"
                                            id="cancel-assign-btn"
                                            x-on:click="closeModal"
                                            class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-medium rounded-md transition-colors duration-200">
                                        Batal
                                    </button>
                                    <button type="button"
                                            id="submit-assign-btn"
                                            x-on:click="validateAndSubmit()"
                                            x-bind:disabled="submitting"
                                            class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-md transition-colors duration-200 disabled:opacity-50">
                                        <span x-show="submitting">
                                            <i class="fas fa-spinner fa-spin mr-1"></i>
                                        </span>
                                        Tugaskan
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- assignModal component is registered in alpine-components.js for CSP compliance -->
</body>
</html>
